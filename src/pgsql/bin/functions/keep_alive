#!/usr/bin/env bash

echo ">>> Keep container alive..."

set -e 

ELAPSED=0 
started=$(mktemp)
echo "False" > $started
until [ -f /tmp/repmgrd.pid ] && echo "True" > $started || [ $ELAPSED -eq 10 ]; do 
    sleep 1
    (( ELAPSED++ ))
done

if [[ $(cat $started) == "True" ]]; then 
    echo ">>> repmgrd started after $ELAPSED seconds"
else
    echo ">>> FAILED: repmgrd start timed out after $ELAPSED seconds"
fi

echo ">>> REPMGRD_PID=`cat /tmp/repmgrd.pid | head -1`"

while [[ `pidof repmgrd` != '' ]] || [[ -f /var/run/recovery.lock ]] ; do
    sleep 5
done

echo ">>> Main process terminated, container will shutdown..."
exit 0